name: é£ä¹¦æ¨é€é€šçŸ¥

on:
  push:
    branches: [ '*' ]  # ç›‘å¬æ‰€æœ‰åˆ†æ”¯çš„æ¨é€
  pull_request:
    branches: [ '*' ]  # ç›‘å¬æ‰€æœ‰åˆ†æ”¯çš„PR
    types: [opened, closed]

jobs:
  notify-feishu:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è·å–æ¨é€ä¿¡æ¯
      id: get_info
      run: |
        echo "COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{ github.sha }} | head -n 1)" >> $GITHUB_OUTPUT
        echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "REPO_NAME=${{ github.repository }}" >> $GITHUB_OUTPUT
        echo "AUTHOR_NAME=${{ github.actor }}" >> $GITHUB_OUTPUT
        
    - name: å‘é€é£ä¹¦é€šçŸ¥
      run: |
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†é£ä¹¦ Webhook URL
        if [ -z "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
          echo "âš ï¸ æœªé…ç½® FEISHU_WEBHOOK_URLï¼Œè·³è¿‡é£ä¹¦é€šçŸ¥"
          exit 0
        fi
        
        if [ "${{ github.event_name }}" = "push" ]; then
          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "content": "ğŸš€ **ä»£ç æ¨é€é€šçŸ¥**\n\n**ä»“åº“**: ${{ steps.get_info.outputs.REPO_NAME }}\n**åˆ†æ”¯**: ${{ steps.get_info.outputs.BRANCH_NAME }}\n**æäº¤è€…**: ${{ steps.get_info.outputs.AUTHOR_NAME }}\n**æäº¤ID**: `${{ steps.get_info.outputs.COMMIT_SHA }}`\n**æäº¤ä¿¡æ¯**: ${{ steps.get_info.outputs.COMMIT_MESSAGE }}",
                    "tag": "lark_md"
                  }
                },
                {
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æäº¤",
                        "tag": "lark_md"
                      },
                      "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
                      "type": "default",
                      "value": {}
                    }
                  ],
                  "tag": "action"
                }
              ],
              "header": {
                "title": {
                  "content": "GitHub æ¨é€é€šçŸ¥",
                  "tag": "plain_text"
                },
                "template": "blue"
              }
            }
          }'
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ github.event.action }}" = "opened" ]; then
            curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "content": "ğŸ“‹ **Pull Request åˆ›å»ºé€šçŸ¥**\n\n**ä»“åº“**: ${{ github.repository }}\n**åˆ†æ”¯**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}\n**åˆ›å»ºè€…**: ${{ github.actor }}\n**æ ‡é¢˜**: ${{ github.event.pull_request.title }}",
                      "tag": "lark_md"
                    }
                  },
                  {
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "content": "æŸ¥çœ‹ PR",
                          "tag": "lark_md"
                        },
                        "url": "${{ github.event.pull_request.html_url }}",
                        "type": "default",
                        "value": {}
                      }
                    ],
                    "tag": "action"
                  }
                ],
                "header": {
                  "title": {
                    "content": "GitHub PR é€šçŸ¥",
                    "tag": "plain_text"
                  },
                  "template": "green"
                }
              }
            }'
          elif [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "content": "âœ… **Pull Request åˆå¹¶é€šçŸ¥**\n\n**ä»“åº“**: ${{ github.repository }}\n**åˆ†æ”¯**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}\n**åˆå¹¶è€…**: ${{ github.actor }}\n**æ ‡é¢˜**: ${{ github.event.pull_request.title }}",
                      "tag": "lark_md"
                    }
                  },
                  {
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "content": "æŸ¥çœ‹ PR",
                          "tag": "lark_md"
                        },
                        "url": "${{ github.event.pull_request.html_url }}",
                        "type": "default",
                        "value": {}
                      }
                    ],
                    "tag": "action"
                  }
                ],
                "header": {
                  "title": {
                    "content": "GitHub PR åˆå¹¶é€šçŸ¥",
                    "tag": "plain_text"
                  },
                  "template": "purple"
                }
              }
            }'
          fi
        fi