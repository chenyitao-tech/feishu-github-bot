name: é£ä¹¦æ¨é€é€šçŸ¥

on:
  push:
    branches: [ '*' ]  # ç›‘å¬æ‰€æœ‰åˆ†æ”¯çš„æ¨é€
  pull_request:
    branches: [ '*' ]  # ç›‘å¬æ‰€æœ‰åˆ†æ”¯çš„PR
    types: [opened, closed]

jobs:
  notify-feishu:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è·å–æ¨é€ä¿¡æ¯
      id: get_info
      run: |
        echo "COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{ github.sha }} | head -n 1)" >> $GITHUB_OUTPUT
        echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "REPO_NAME=${{ github.repository }}" >> $GITHUB_OUTPUT
        echo "AUTHOR_NAME=${{ github.actor }}" >> $GITHUB_OUTPUT
        
    - name: å‘é€é£ä¹¦é€šçŸ¥
      run: |
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†é£ä¹¦ Webhook URL
        if [ -z "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
          echo "âš ï¸ æœªé…ç½® FEISHU_WEBHOOK_URLï¼Œè·³è¿‡é£ä¹¦é€šçŸ¥"
          exit 0
        fi
        
        # ç”Ÿæˆæ—¶é—´æˆ³
        timestamp=$(date +%s)
        
        # æ„å»ºåŸºç¡€æ¶ˆæ¯ä½“
        if [ "${{ github.event_name }}" = "push" ]; then
          message_body='{
            "msg_type": "interactive",
            "card": {
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "content": "ğŸš€ **ä»£ç æ¨é€é€šçŸ¥**\n\n**ä»“åº“**: ${{ steps.get_info.outputs.REPO_NAME }}\n**åˆ†æ”¯**: ${{ steps.get_info.outputs.BRANCH_NAME }}\n**æäº¤è€…**: ${{ steps.get_info.outputs.AUTHOR_NAME }}\n**æäº¤ID**: `${{ steps.get_info.outputs.COMMIT_SHA }}`\n**æäº¤ä¿¡æ¯**: ${{ steps.get_info.outputs.COMMIT_MESSAGE }}",
                    "tag": "lark_md"
                  }
                },
                {
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æäº¤",
                        "tag": "lark_md"
                      },
                      "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
                      "type": "default",
                      "value": {}
                    }
                  ],
                  "tag": "action"
                }
              ],
              "header": {
                "title": {
                  "content": "GitHub æ¨é€é€šçŸ¥",
                  "tag": "plain_text"
                },
                "template": "blue"
              }
            }
          }'
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ github.event.action }}" = "opened" ]; then
            message_body='{
              "msg_type": "interactive",
              "card": {
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "content": "ğŸ“‹ **Pull Request åˆ›å»ºé€šçŸ¥**\n\n**ä»“åº“**: ${{ github.repository }}\n**åˆ†æ”¯**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}\n**åˆ›å»ºè€…**: ${{ github.actor }}\n**æ ‡é¢˜**: ${{ github.event.pull_request.title }}",
                      "tag": "lark_md"
                    }
                  },
                  {
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "content": "æŸ¥çœ‹ PR",
                          "tag": "lark_md"
                        },
                        "url": "${{ github.event.pull_request.html_url }}",
                        "type": "default",
                        "value": {}
                      }
                    ],
                    "tag": "action"
                  }
                ],
                "header": {
                  "title": {
                    "content": "GitHub PR é€šçŸ¥",
                    "tag": "plain_text"
                  },
                  "template": "green"
                }
              }
            }'
          elif [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            message_body='{
              "msg_type": "interactive",
              "card": {
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "content": "âœ… **Pull Request åˆå¹¶é€šçŸ¥**\n\n**ä»“åº“**: ${{ github.repository }}\n**åˆ†æ”¯**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}\n**åˆå¹¶è€…**: ${{ github.actor }}\n**æ ‡é¢˜**: ${{ github.event.pull_request.title }}",
                      "tag": "lark_md"
                    }
                  },
                  {
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "content": "æŸ¥çœ‹ PR",
                          "tag": "lark_md"
                        },
                        "url": "${{ github.event.pull_request.html_url }}",
                        "type": "default",
                        "value": {}
                      }
                    ],
                    "tag": "action"
                  }
                ],
                "header": {
                  "title": {
                    "content": "GitHub PR åˆå¹¶é€šçŸ¥",
                    "tag": "plain_text"
                  },
                  "template": "purple"
                }
              }
            }'
          else
            echo "å¿½ç•¥çš„PRäº‹ä»¶: ${{ github.event.action }}"
            exit 0
          fi
        else
          echo "å¿½ç•¥çš„äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          exit 0
        fi
        
        # å¦‚æœé…ç½®äº†ç­¾åå¯†é’¥ï¼Œæ·»åŠ ç­¾å
        if [ -n "${{ secrets.FEISHU_SECRET }}" ]; then
          # ç”Ÿæˆç­¾å
          string_to_sign="${timestamp}\n${{ secrets.FEISHU_SECRET }}"
          sign=$(echo -ne "$string_to_sign" | openssl dgst -sha256 -hmac "" -binary | base64)
          
          # æ·»åŠ æ—¶é—´æˆ³å’Œç­¾ååˆ°æ¶ˆæ¯ä½“
          final_message=$(echo "$message_body" | jq --arg ts "$timestamp" --arg sign "$sign" '. + {timestamp: $ts, sign: $sign}')
        else
          final_message="$message_body"
        fi
        
        # å‘é€æ¶ˆæ¯
        echo "å‘é€é£ä¹¦æ¶ˆæ¯..."
        response=$(curl -s -w "%{http_code}" -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d "$final_message")
        
        http_code="${response: -3}"
        response_body="${response%???}"
        
        echo "HTTPçŠ¶æ€ç : $http_code"
        echo "å“åº”å†…å®¹: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… é£ä¹¦æ¶ˆæ¯å‘é€æˆåŠŸ"
        else
          echo "âŒ é£ä¹¦æ¶ˆæ¯å‘é€å¤±è´¥"
          exit 1
        fi